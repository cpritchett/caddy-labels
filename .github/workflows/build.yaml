name: Build Container
run-name: Build Container

on:
    push:

jobs:

    publish:
        name: Build & Push Dockerfile
        runs-on: ubuntu-latest
        container: node
        steps:
            - name: Get Version Number
              run: echo "VERSION=$(cat Dockerfile | grep "ARG CADDY_VERSION" | grep -Eo '=.+' | grep -Eo '[[:alnum:]\.\/\-]+')" >> $GITHUB_ENV

            - name: Push Version
              uses: ztimson/actions/.github/workflows/docker.yaml@develop
              with:
                  name: ztimson/caddy-labels:${{env.VERSION}}
                  repository: ${{github.server_url}}/${{github.repository}}.git
                  pass: ${{secrets.DEPLOY_TOKEN}}

            - name: Push Latest
              if: github.ref == 'refs/heads/master'
              uses: ztimson/actions/.github/workflows/docker.yaml@develop
              with:
                name: ztimson/caddy-labels:latest
                repository: ${{github.server_url}}/${{github.repository}}.git
                pass: ${{secrets.DEPLOY_TOKEN}}

    tag:
        name: Tag Version
        needs: publish
        runs-on: ubuntu-latest
        container: node
        steps:
            - name: Clone Repository
              uses: ztimson/actions/clone@develop

            - name: Get Version Number
              run: echo "VERSION=$(cat Dockerfile | grep "ARG CADDY_VERSION" | grep -Eo '=.+' | grep -Eo '[[:alnum:]\.\/\-]+')" >> $GITHUB_ENV

            - name: Tag Version
              uses: ztimson/actions/tag@develop
              with:
                  tag: ${{env.VERSION}}
